<!DOCTYPE html>
<html lang="fr">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

		<script src="https://aframe.io/releases/0.9.2/aframe.min.js"></script>
		<script src="https://rawgit.com/donmccurdy/aframe-extras/master/dist/aframe-extras.loaders.min.js"></script>
  	<script src="https://unpkg.com/aframe-environment-component/dist/aframe-environment-component.min.js"></script>
		<script src="./unlock_audio_ios.js"></script>


<script>
		AFRAME.registerComponent('loaded', {
			init: function () {
				var el = this.el;
				el.addEventListener('model-loaded', () => {
					console.log(el.id+" chargé");
					});
				this.el.addEventListener('model-error', () => {
						// Grab the mesh / scene.
						console.log("erreur");
					});
				}
		});



		AFRAME.registerComponent('fini', {
			init: function () {
				var el = this.el;
				el.addEventListener('animation-finished', () => {
					console.log(el.id+" fini");
					});
				}
		});



		AFRAME.registerComponent('switch', {
			init: function () {
				var el = this.el;
				var change = 0;
				function getRandomInt(min, max) {
					min = Math.ceil(min);
					max = Math.floor(max);
					return Math.floor(Math.random() * (max - min + 1)) + min;
};
				el.addEventListener('animation-finished', () => {
					change = getRandomInt(1,5);
					console.log(el.id+"switch"+change);


					});
				}
		});
</script>


  </head>

  <body>

		<a-scene background="color: skyblue">
			<a-assets>
				<a-asset-item id="glbModel" src="./models/Antoine_Hugo.glb"></a-asset-item>
				<audio id="son" src="./zorba.mp3" preload="auto" autoplay="true" loop="false"></audio>
			</a-assets>


			#lumières et evironnement
			<a-entity light="type: ambient; color: #CCC; intensity: 0.5"></a-entity>
			<a-entity light="type: directional; castShadow:true; color: red; intensity: 0.5" position="-1 2 1"></a-entity>
			<a-entity environment="preset:  yavapai;  dressingAmount:  30;  skyColor:  #5a7cef;  horizonColor:  #d7edfd;" shadow="receive: true"></a-entity>


			#personnage (utiliser "pas 01" "pas 02" ou "pas 03")
			<a-entity   id ="Antoine"
						fini
						switch
			      scale="1 1 1"
			      position="0 0 -3"
			      rotation="90 90 0"s
			      loaded
			      animation-mixer="clip : pas_03 ; clampWhenFinished: true; duration : 4"
			      gltf-model="#glbModel"
			      shadow="cast:true"
			      shadow="receive: true"
						sound="src: #son;">
			</a-entity>

			#camera
			<a-entity id="camera" position="0 1.6 0" camera look-controls></a-entity>
    	</a-scene>

			        <!-- GESTION AUDIO -->
			        <button id="bouton" style="position: absolute; left: 20px; bottom: 20px;">SON ON</button>

			        <script>
			            var b = document.querySelector('#bouton');
			            var son_vol = document.querySelector('#son');

			            var AudioContext = window.AudioContext || window.webkitAudioContext;
			            var contexteAudio = new AudioContext;

			            unlockAudioIOS(contexteAudio); // ok pour context = AudioContext;

			            function resumeAudio() {
			                console.log(contexteAudio.state);

			                if(contexteAudio.state == "suspended")
			                {
			                      contexteAudio.resume();
			                      console.log('Playback resumed successfully');
			                      son_vol.play();
			                      b.innerHTML = "SON OFF";
			                      console.log("SON OFF");
			                }
			                else {
			                      contexteAudio.suspend();
			                      console.log('Playback paused successfully');
			                      son_vol.pause();
			                      b.innerHTML = "SON ON";
			                      console.log("SON ON");
			                }
			                //document.removeEventListener("click", resumeAudio);
			            }
			            b.onclick = resumeAudio;

			          </script>
  </body>
</html>
